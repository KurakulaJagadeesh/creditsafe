// This script is to inject some additional criteria into the search criteria object.
// The script is run before the build process to ensure that the criteria object is updated before the build process begins.

import fs from 'fs';
import path from 'path';
import util from 'util';
import criteriaObject from '@usp-monorepo/usp-core/config/directorExternalCriterias.mjs';

const initialiseSearchCriterias = (criteriasObject) => {
	// Move nested fields (`address` and `company`) to the top level within criteriaSets
	const injectFieldsToTopLevel = (parsedCriteriasObject, country) => {
		const updatedCriteriaSets = parsedCriteriasObject.searchCriteria[country].criteriaSets.map((set) => {
			// Destructure nested fields if they exist, and move their properties to the top level
			const { address = {}, company = {}, ...rest } = set;

			return {
				...rest,
				...address,
				...company,
			};
		});

		// Return updated structure with modified criteriaSets
		return {
			...parsedCriteriasObject.searchCriteria[country],
			criteriaSets: updatedCriteriaSets,
		};
	};

	// Process each country in the searchCriteria
	const updatedSearchCriteria = Object.keys(criteriasObject.searchCriteria).reduce((acc, country) => {
		acc[country] = injectFieldsToTopLevel(criteriasObject, country);
		return acc;
	}, {});

	// Return the updated object with modified searchCriteria
	return {
		...criteriasObject,
		searchCriteria: updatedSearchCriteria,
	};
};

const modifyCriterias = () => {
	console.log('Modifying criterias.json to nested fields to the top level.');
	const updatedCriteriaObject = initialiseSearchCriterias(criteriaObject);

	const objectAsString = util.inspect(updatedCriteriaObject, {
		compact: false,
		depth: null,
		maxArrayLength: null,
		maxStringLength: null,
	});

	// Create a new Date object representing the current date and time
	const now = new Date();

	// Convert the date to an ISO 8601 formatted string
	const isoString = now.toISOString();

	// Create the export statement
	const fileContent = `// This file was auto-generated by pre-build.mjs on ${isoString}\n// Do not edit manually.\n\nexport default ${objectAsString};`;

	// Write to the .mjs file so it can be imported as an ESM module
	fs.writeFileSync(path.resolve('../../core/config/directorInternalCriterias.mjs'), fileContent);
	console.log('Successfully modified criterias.');
};

export default modifyCriterias;
