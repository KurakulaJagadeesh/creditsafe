/* eslint-disable no-underscore-dangle */
import assert from 'node:assert';
import { describe, it } from 'node:test';
import filterResults from '../src/mappings/groupResultsCA.mjs';

describe('groupResultsCA', () => {
	it('should return the correct group results', () => {
		const testInputArray = [
			{
				avgScore: 99,
				queryInfo: [{ keys: 'name,groupResults', type: 'text', matchScore: 99 }],
				result: {
					_index: 'cs-company-search-ca.2024-09-12.16-27-45',
					_id: 'CA03495501',
					_score: 167.02254,
					_source: {
						recordType: '1',
						connectId: 'CA-X-CA08958229',
						riskRating: 'C',
						regNo: '1148805626',
						'@version': '1',
						phoneNumbers: { raw: ['5143956611'] },
						countryCode: 'CA',
						safeNo: 'CA03495501',
						riskScore: '1296',
						officeType: 'headOffice',
						noEmployees: { to: 200, from: 1 },
						address: {
							province: 'province',
							line1: 'line1',
							county: 'county',
							city: 'city',
							simpleValue: 'simpleValue',
							postCode: { outCode: 'outCode', full: 'full', raw: 'raw' },
						},
						name: 'NATIONAL BANK HEAD OFFICE',
						activityCodes: ['60210000'],
						significantItems: 58,
						recordStatus: 'I',
						turnover: { to: 8927000000, from: 8927000000 },
						creditLimit: 350000,
						status: 'Active',
						companyId: { exPrefix: '08958229', full: 'ca08958229', raw: 'CA08958229' },
						lastUpdateDate: '2024-08-15T02:10:42.280Z',
						incorportationDate: '2000-02-08T00:00:00.000Z',
						groupId: 'CA03495501',
						'@timestamp': '2024-09-12T16:18:55.247Z',
						orgNo: '0136329162',
						fileNo: '0136329162',
					},
				},
			},
			{
				avgScore: 99,
				queryInfo: [{ keys: 'name,groupResults', type: 'text', matchScore: 99 }],
				result: {
					_index: 'cs-company-search-ca.2024-09-12.16-27-45',
					_id: 'CA12345678',
					_score: 167.02254,
					_source: {
						recordType: '1',
						connectId: 'CA-X-CA08958229',
						riskRating: 'C',
						regNo: '1148805626',
						'@version': '1',
						phoneNumbers: { raw: ['5143956611'] },
						countryCode: 'CA',
						safeNo: 'CA12345678',
						riskScore: '1296',
						officeType: 'headOffice',
						noEmployees: { to: 200, from: 1 },
						address: {
							province: 'province',
							line1: 'line1',
							county: 'county',
							city: 'city',
							simpleValue: 'simpleValue',
							postCode: { outCode: 'outCode', full: 'full', raw: 'raw' },
						},
						name: 'NATIONAL BANK BRANCH',
						activityCodes: ['60210000'],
						significantItems: 58,
						recordStatus: 'I',
						turnover: { to: 8927000000, from: 8927000000 },
						creditLimit: 350000,
						status: 'Active',
						companyId: { exPrefix: '08958229', full: 'ca08958229', raw: 'CA08958229' },
						lastUpdateDate: '2024-08-15T02:10:42.280Z',
						incorportationDate: '2000-02-08T00:00:00.000Z',
						groupId: 'CA03495501',
						'@timestamp': '2024-09-12T16:18:55.247Z',
						orgNo: '0136329162',
						fileNo: '0136329162',
					},
				},
			},
			{
				avgScore: 99,
				queryInfo: [{ keys: 'name,groupResults', type: 'text', matchScore: 99 }],
				result: {
					_index: 'cs-company-search-ca.2024-09-12.16-27-45',
					_id: 'CA987654321',
					_score: 167.02254,
					_source: {
						recordType: '1',
						connectId: 'CA-X-CA08958229',
						riskRating: 'C',
						regNo: '1148805626',
						'@version': '1',
						phoneNumbers: { raw: ['5143956611'] },
						countryCode: 'CA',
						safeNo: 'CA987654321',
						riskScore: '1296',
						officeType: 'headOffice',
						noEmployees: { to: 200, from: 1 },
						address: {
							province: 'province',
							line1: 'line1',
							county: 'county',
							city: 'city',
							simpleValue: 'simpleValue',
							postCode: { outCode: 'outCode', full: 'full', raw: 'raw' },
						},
						name: 'Tim Hortons HQ',
						activityCodes: ['60210000'],
						significantItems: 58,
						recordStatus: 'I',
						turnover: { to: 8927000000, from: 8927000000 },
						creditLimit: 350000,
						status: 'Active',
						companyId: { exPrefix: '08958229', full: 'ca08958229', raw: 'CA08958229' },
						lastUpdateDate: '2024-08-15T02:10:42.280Z',
						incorportationDate: '2000-02-08T00:00:00.000Z',
						groupId: 'CA987654321',
						'@timestamp': '2024-09-12T16:18:55.247Z',
						orgNo: '0136329162',
						fileNo: '0136329162',
					},
				},
			},
		];

		const expectedOutput = [
			{
				avgScore: 99,
				queryInfo: [{ keys: 'name,groupResults', type: 'text', matchScore: 99 }],
				result: {
					_id: 'CA03495501',
					_index: 'cs-company-search-ca.2024-09-12.16-27-45',
					_score: 167.02254,
					_source: {
						recordType: '1',
						connectId: 'CA-X-CA08958229',
						riskRating: 'C',
						regNo: '1148805626',
						'@version': '1',
						phoneNumbers: { raw: ['5143956611'] },
						countryCode: 'CA',
						safeNo: 'CA03495501',
						riskScore: '1296',
						officeType: 'headOffice',
						noEmployees: { to: 200, from: 1 },
						address: {
							province: 'province', line1: 'line1', county: 'county', city: 'city', simpleValue: 'simpleValue', postCode: { outCode: 'outCode', full: 'full', raw: 'raw' },
						},
						name: 'NATIONAL BANK HEAD OFFICE',
						activityCodes: ['60210000'],
						significantItems: 58,
						recordStatus: 'I',
						turnover: { to: 8927000000, from: 8927000000 },
						creditLimit: 350000,
						status: 'Active',
						companyId: { exPrefix: '08958229', full: 'ca08958229', raw: 'CA08958229' },
						lastUpdateDate: '2024-08-15T02:10:42.280Z',
						incorportationDate: '2000-02-08T00:00:00.000Z',
						groupId: 'CA03495501',
						'@timestamp': '2024-09-12T16:18:55.247Z',
						orgNo: '0136329162',
						fileNo: '0136329162',
						alternative: [{
							safeNo: 'CA12345678',
							name: 'NATIONAL BANK BRANCH',
							status: 'Active',
							simpleValue: 'simpleValue',
							street: 'line1',
							city: 'city',
							province: 'province',
							groupId: 'CA03495501',
						}],
					},
				},
			},
			{
				avgScore: 99,
				queryInfo: [{ keys: 'name,groupResults', type: 'text', matchScore: 99 }],
				result: {
					_id: 'CA987654321',
					_index: 'cs-company-search-ca.2024-09-12.16-27-45',
					_score: 167.02254,
					_source: {
						recordType: '1',
						connectId: 'CA-X-CA08958229',
						riskRating: 'C',
						regNo: '1148805626',
						'@version': '1',
						phoneNumbers: { raw: ['5143956611'] },
						countryCode: 'CA',
						safeNo: 'CA987654321',
						riskScore: '1296',
						officeType: 'headOffice',
						noEmployees: { to: 200, from: 1 },
						address: {
							province: 'province', line1: 'line1', county: 'county', city: 'city', simpleValue: 'simpleValue', postCode: { outCode: 'outCode', full: 'full', raw: 'raw' },
						},
						name: 'Tim Hortons HQ',
						activityCodes: ['60210000'],
						significantItems: 58,
						recordStatus: 'I',
						turnover: { to: 8927000000, from: 8927000000 },
						creditLimit: 350000,
						status: 'Active',
						companyId: { exPrefix: '08958229', full: 'ca08958229', raw: 'CA08958229' },
						lastUpdateDate: '2024-08-15T02:10:42.280Z',
						incorportationDate: '2000-02-08T00:00:00.000Z',
						groupId: 'CA987654321',
						'@timestamp': '2024-09-12T16:18:55.247Z',
						orgNo: '0136329162',
						fileNo: '0136329162',
						alternative: [],
					},
				},
			},
		];

		const actualOutput = filterResults(testInputArray);

		assert.deepStrictEqual(actualOutput, expectedOutput);
	});

	it('should allow only 50 alternatives per group', () => {
		const templateObject = {
			avgScore: 99,
			queryInfo: [{ keys: 'name,groupResults', type: 'text', matchScore: 99 }],
			result: {
				_index: 'cs-company-search-ca.2024-09-12.16-27-45',
				_id: 'CA03495501',
				_score: 167.02254,
				_source: {
					recordType: '1',
					connectId: 'CA-X-CA08958229',
					riskRating: 'C',
					regNo: '1148805626',
					'@version': '1',
					phoneNumbers: { raw: ['5143956611'] },
					countryCode: 'CA',
					safeNo: 'CA03495501',
					riskScore: '1296',
					officeType: 'headOffice',
					noEmployees: { to: 200, from: 1 },
					address: {
						province: 'province',
						line1: 'line1',
						county: 'county',
						city: 'city',
						simpleValue: 'simpleValue',
						postCode: { outCode: 'outCode', full: 'full', raw: 'raw' },
					},
					name: 'NATIONAL BANK HEAD OFFICE',
					activityCodes: ['60210000'],
					significantItems: 58,
					recordStatus: 'I',
					turnover: { to: 8927000000, from: 8927000000 },
					creditLimit: 350000,
					status: 'Active',
					companyId: { exPrefix: '08958229', full: 'ca08958229', raw: 'CA08958229' },
					lastUpdateDate: '2024-08-15T02:10:42.280Z',
					incorportationDate: '2000-02-08T00:00:00.000Z',
					groupId: 'CA03495501',
					'@timestamp': '2024-09-12T16:18:55.247Z',
					orgNo: '0136329162',
					fileNo: '0136329162',
				},
			},
		};
		const testInputArray = Array.from({ length: 60 }, () => templateObject);

		const actualOutput = filterResults(testInputArray);
		assert.equal(actualOutput[0].result._source.alternative.length, 50);
	});
});
